 <!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Reservation Page</title>
<link rel="shortcut icon" type="image/jpg" href="images/parking icon.jpg">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<link href="styles/styles.css" rel="stylesheet" type="text/css">
<link href="css/availabilitypage.css" rel="stylesheet" type="text/css">
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.652.0.min.js"></script>
<script src="https://www.paypalobjects.com/api/checkout.js"></script>
<script type="text/javascript">
AWS.config.update({
	  region: "us-east-2",
	  endpoint: 'http://dynamodb.us-east-2.amazonaws.com',
	  accessKeyId: "AKIASUU5L6BWABM3DQEC",
	  secretAccessKey: "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"
	});  
 
var dynamodb = new AWS.DynamoDB();
var docClient = new AWS.DynamoDB.DocumentClient();
var ddb = new AWS.DynamoDB({apiVersion: '2012-08-10'});
function ReserveSpace()
{
		const UserName=sessionStorage.getItem("UserName");
		const current_datetime=new Date();
		const Bookingdate= document.getElementById('date').value;
		const Flag="Null";
		const FromTime=document.getElementById('From').value;
		const PaymentAmount=document.getElementById('payamount').value;
		const Paymentmethod="paypal";
		const status="Y";
		const ToTime=document.getElementById('To').value;
		const SensorName=document.getElementById('Slot').value;
		const VehicleNumber=document.getElementById('Vnum').value;
	   console.log(FromTime);
	   console.log(ToTime);
	   console.log(SensorName);
	   console.log(VehicleNumber);
	   
	   
	   
	   var params={
				 TableName : "UserTypeCount",
				
			        KeyConditionExpression: "#susername = :UserType",
			        ExpressionAttributeNames:{
			            "#susername": "UserType"
			        },
			        ExpressionAttributeValues: {
			        	":UserType":"Bookings"
			        }
			       
			};
			docClient.query(params, function(err, data) {
				if(err)
					{
					console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
					}
				else
					{
								console.log(data.Count);
				   					var coustr;
				   					data.Items.forEach(function(movie) {
				   						console.log(movie);
				                     coustr=movie.Count+1;
				                     console.log("latest BookingId:"+coustr)
				   					console.log(coustr);
							   			var params1={
										TableName : "BookingDetail",
										Item:{
											UserName:{S:UserName},
											BookingId:{N:coustr.toString()},
											BookingDate:{S:Bookingdate},
											Flag:{S:Flag},
											FromTime:{S:FromTime},
											PaymentAmount:{S:PaymentAmount},
											PaymentMethod:{S:Paymentmethod},
											Status:{S:status},
											ToTime:{S:ToTime},
											SensorName:{S:SensorName},
											VehicleNumber:{S:VehicleNumber},
											Email:{S:sessionStorage.getItem("Email")}
										}
									};
							   console.log("ok till now")
							   dynamodb.putItem(params1,function(err, data){
									if (err)
										{
										console.log(err, err.stack); // an error occurred
										}
									   else    
										   {
										   console.log("Inserted");
										   if (window.confirm("your booking has been made.")) { 
											   window.location.href="Bookings.html";
											 }		   
										   }
							
							   
							});
							   console.log(coustr+": coustr")
							   var params2={
										TableName : "UserTypeCount",
										Item:{
											UserType:{S:"Bookings"},
											Count:{N:coustr.toString()}
										}
								};
								dynamodb.putItem(params2,function(err, data){
									if (err) console.log(err, err.stack); // an error occurred
									   else     console.log(data);
								});
							   
							});
				   }
					
			});
	   
	   
	   
}
function appendLeadingZeroes(n){
	  if(n <= 9){
	    return "0" + n;
	  }
	  return n
	}
function displaytooptions()
{
	console.log("in displaytooptions method");
	var selector=document.getElementById("From");
	console.log(selector.selectedIndex);
	var n=selector.selectedIndex;
	var options = document.querySelectorAll('#To option');
	  options.forEach(o => o.remove());
	for (i = n; i < 24; i++) {
		console.log("in for loop");
	var x = document.getElementById("To");
	  var option = document.createElement("option");
	  
	  option.value = appendLeadingZeroes(i)+":00";
	  option.text=appendLeadingZeroes(i)+":00";
	  x.add(option);
	}
	displayslots();
	}
function displayslots() {
	var n1=document.getElementById("From").value.substring(0,2);
	var n2=document.getElementById("To").value.substring(0,2);
	console.log("value: "+document.getElementById("To").value);
	console.log("text: "+document.getElementById("To").innerHTML);
	console.log(n1);
	console.log(n2);
	var amount=(n2-n1) * 10;
	console.log(amount);
	document.getElementById("payamount").value=amount;
	var options = document.querySelectorAll('#Slot option');
	  options.forEach(o => o.remove());
	  const current_datetime=new Date();
		const todaydate= current_datetime.getFullYear()+ "-"+ appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate()) ;
		console.log(todaydate);
	var params={
			 TableName : "BookingDetail",
			 FilterExpression: " #FromTime between :one AND :two AND #BookingDate = :date OR #ToTime between :one AND :two AND #BookingDate = :date",
			 ExpressionAttributeNames:{
		            "#FromTime":"FromTime",
		            "#ToTime":"ToTime",
		            "#BookingDate":"BookingDate"
		        },
		        ExpressionAttributeValues: {
		        	":one":document.getElementById("From").value,
		        	":two":document.getElementById("To").value,
		        	":date":todaydate
		        }
		        
		};
	docClient.scan(params, onScan);
	function onScan(err, data) {
		if(err)
			{
			console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
			}else{
				var count=data.Count;
				console.log(count);
				var slots=["Slot 1","Slot 2","Slot 3","Slot 4","Slot 5"];
				data.Items.forEach(function(movie) {
	                  
	                  if(slots.includes(movie.SensorName))
	                  {
	                	  delete slots[slots.indexOf(movie.SensorName)];
	                  }
	                  else
	                  {
	                  	
	                  }
	              });
				slots.sort();
				var x = document.getElementById("Slot");
				slots.forEach(myFunction); 
				function myFunction(item, index) 
				{ 
					console.log(item);
					  var option = document.createElement("option");
					  option.text = item;
					  option.id=item;
					  x.add(option);
					}
				
			}
	}
	
}
function checkBookings()
{
	const current_datetime=new Date();
	const Todaydate= current_datetime.getFullYear()+ "-"+ appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate()) ;

	var today = new Date().toISOString().split('T')[0];
	console.log(today);
	document.getElementsByName("date")[0].setAttribute('min', today);
	console.log(today);
	var params = {
	        TableName : "BookingDetail",
	        ScanIndexForward: true,
	        FilterExpression: "#user = :name AND #BookingDate = :date",
	        ExpressionAttributeNames: {
	            "#user": "UserName",
	            "#BookingDate":"BookingDate"
	        },
	        ExpressionAttributeValues: { ":name": sessionStorage.getItem("UserName"),":date":Todaydate}
	             
	    };
	    docClient.scan(params, onScan);
	}
function onScan(err, data) {
    if (err) {
        console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
    }
    else
    {        
     if(data.Count>=5)
    {
    	 if (window.confirm("Sorry! you exceeded maximum bookings")) { 
			   window.location.href="Bookings.html";
			 }	
    	 
    	 }
     else
 	{
 	document.getElementById("form").style.display='block';
 	}
    }
    
    }
</script>

</head>
<body onload="checkBookings()">
<header>
<div class="topnav">
  <a href="SlotAvailability.html"><i class="fa fa-fw fa-home"></i> Home</a>
  <a href="Bookings.html">My Bookings</a>
  <a href="CancelledBookings.html">Cancellations</a>
  <div class="dropdown">
    <button class="dropbtn" >More <i class="fa fa-caret-down"></i></button>
    <div class="dropdown-content">
      <a>Peak Hours</a>
      <a href="About.html">About</a>
      <a href="Contact.html">Contact us</a>
    </div>
  </div> 
  <div class="topnav-right">
     <div class="dropdown">
    <button class="dropbtn" style="background-color: #B0E0E6;color: black;">My Account <i class="fa fa-user-circle"></i></button>
    <div class="dropdown-content">
      <a href="MyAccount.html">Profile</a>
      <a href="index.html"><i class="fa fa-sign-out"></i>Logout </a>
    </div>
  </div> 
  </div>
</div>
</header>
<div align="center" class="form-container" id="form" style=" padding-top:20px; display:none">
<form  style="width: 600px; height: 700px; border-style: groove; border-radius:15px; background-color: white; padding-top:25px; padding-left:120px" onsubmit="return false;">
<h1 style="font: 20px/1.4em Verdana, sans-serif; float:left">Reserve a space..</h1>
</br>
</br>
<label class="label-form" for="datelabel">Select Date:</label>
  <input type="date"  id="date" required="Required" style="font-size:15px" class="input-form" name="date" placeholder="Select suitable date" />
  </br>
  </br>

<label class="label-form" for="From" >From:</label>
  <select name="From" class="input-form" onchange="displaytooptions(this.id)" id="From">
  <option disabled selected value> </option>
    <option value="00:00">00:00</option>
	<option value="01:00">01:00</option>
	<option value="02:00">02:00</option>
	<option value="03:00">03:00</option>
	<option value="04:00">04:00</option>
	<option value="05:00">05:00</option>
	<option value="06:00">06:00</option>
	<option value="07:00">07:00</option>
	<option value="08:00">08:00</option>
	<option value="09:00">09:00</option>
	<option value="10:00">10:00</option>
	<option value="11:00">11:00</option>
	<option value="12:00">12:00</option>
	<option value="13:00">13:00</option>
	<option value="14:00">14:00</option>
	<option value="15:00">15:00</option>
	<option value="16:00">16:00</option>
	<option value="17:00">17:00</option>
	<option value="18:00">18:00</option>
	<option value="19:00">19:00</option>
	<option value="20:00">20:00</option>
	<option value="21:00">21:00</option>
	<option value="22:00">22:00</option>
	<option value="23:00">23:00</option>
  </select>
  <br>
  
   </br>
  </br>
   </br>
  </br>
  <label class="label-form"  for="To" >To :</label>
  <select name="To" class="input-form" onchange="displayslots()" id="To">
  </select>
  </br>
  </br>
  <label class="label-form" for="SelectSlot">Select Slot :</label>
    <select name="Slot" class="input-form" id="Slot">
 </select>
  </br>
  </br>
  <label class="label-form" for="Vehicle Number">Vehicle Number :</label>
  <input  class="input-form"type="text" id="Vnum" name="Vnum"><br><br>
  <label class="label-form" for="payment Amount">Payment Amount in $ :</label>
  <input  class="input-form"type="text" id="payamount" name="payamount" readonly="readonly" ><br><br>
 </br>
    </br>
    </br>
    </br>
   <div id="paypal-button">
  <script>
        paypal.Button.render({

            env: 'sandbox', // sandbox | production

            // PayPal Client IDs - replace with your own
            // Create a PayPal app: https://developer.paypal.com/developer/applications/create
            client: {
                sandbox: 'AeYyMA9Yts9iAuw7c8YBRBRUo16xyopcaBJOmuF3GfMWiqE1gPC09slSDURsFZCLSm33nSoHxu52k90E',
                production: 'AVxLLM-i36D-84l6SzPLxZIeaPc4e-zY1EFbs2V3hrPrg-8KEjVYBitFrOVllgn8ERUmdl4pg44aBPp3'
            },

            // Show the buyer a 'Pay Now' button in the checkout flow
            commit: true,

            // payment() is called when the button is clicked
            payment: function (data, actions) {
                // Make a call to the REST api to create the payment
                return actions.payment.create({
                    payment: {
                        transactions: [
                            {
                                amount: {total: document.getElementById('payamount').value, currency: 'USD'}
                            }
                        ]
                    }
                });
            },

            // onAuthorize() is called when the buyer approves the payment
            onAuthorize: function (data, actions) {
                // Make a call to the REST api to execute the payment
                return actions.payment.execute().then(function () {
                	document.getElementById('reserve').disabled=false;
                  window.alert('Payment Complete!');
                });
            }
        }, '#paypal-button');

    </script>
   </div>
    <button class="input-form-button" id="reserve"  onClick= "ReserveSpace()"  >Reserve</button>
    </div>
    </br>
    </br>
  
</form>


</body>
</html>