<!DOCTYPE html>
<html>
<head>
			<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GDXS5PCQN4"></script>
<script>

if(sessionStorage.getItem("UserType")!="User" ||sessionStorage.getItem("UserName")=="")
{
window.location.href="index.html";
}
</script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GDXS5PCQN4');
</script>
	
<meta charset="ISO-8859-1">
<title>Reservation Page</title>
<link rel="shortcut icon" type="image/jpg" href="images/parking icon.jpg">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<link href="styles/styles.css" rel="stylesheet" type="text/css">
<link href="css/availabilitypage.css" rel="stylesheet" type="text/css">
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.652.0.min.js"></script>
<script src="https://www.paypalobjects.com/api/checkout.js"></script>
<script type="text/javascript">
AWS.config.update({
	  region: "us-east-2",
	  endpoint: 'http://dynamodb.us-east-2.amazonaws.com',
	  accessKeyId: "AKIASUU5L6BWABM3DQEC",
	  secretAccessKey: "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"
	});  
 
var dynamodb = new AWS.DynamoDB();
var docClient = new AWS.DynamoDB.DocumentClient();
var ddb = new AWS.DynamoDB({apiVersion: '2012-08-10'});
function ReserveSpace()
{
	console.log(document.getElementById('date').value +"--"+ document.getElementById('From').value +"--"+ document.getElementById('To').value +"--"+document.getElementById('Vnum').value);
	if(document.getElementById('date').value=="" || document.getElementById('From').value=="" ||document.getElementById('To').value=="" ||document.getElementById('Vnum').value=="")
		{
		
		}
	
	else
	{
	
	if(document.getElementById('useCredit').checked)
		{
		var userid=1;
		console.log(sessionStorage.getItem("UserId"));
		console.log("used credit");
		var params4 = {
		        TableName:"UserDetails",
		        Key:{
		            "UserName": sessionStorage.getItem("UserName"),
		            "UserId": parseInt(sessionStorage.getItem("UserId"))
		        },
		        UpdateExpression: "set AvailableCredit = :r",
		        ExpressionAttributeValues:{
		            ":r":sessionStorage.getItem("todeduct").toString()
		        },
		        ReturnValues:"UPDATED_NEW"
		    };

		    docClient.update(params4, function(err, data) {
		        if (err) {
		            console.log("Unable to update item: " + "\n" + JSON.stringify(err, undefined, 2));
		        } else {
		            console.log("UpdateItem succeeded: " + "\n" + JSON.stringify(data, undefined, 2));
		            document.getElementById('reserve').disabled=false;
		        }
		    });
		
		
		}
	
	
		const UserName=sessionStorage.getItem("UserName");
		const current_datetime=new Date();
		const Bookingdate= document.getElementById('date').value;
		const Flag="Null";
		const FromTime=document.getElementById('From').value;
		const PaymentAmount=document.getElementById('payamount').value;
		const Paymentmethod="paypal";
		const status="Y";
		const ToTime=document.getElementById('To').value;
		const SensorName=document.getElementById('Slot').value;
		const VehicleNumber=document.getElementById('Vnum').value;
	   console.log(FromTime);
	   console.log(ToTime);
	   console.log(SensorName);
	   console.log(VehicleNumber);
	   
	   
	   
	   var params={
				 TableName : "UserTypeCount",
				
			        KeyConditionExpression: "#susername = :UserType",
			        ExpressionAttributeNames:{
			            "#susername": "UserType"
			        },
			        ExpressionAttributeValues: {
			        	":UserType":"Bookings"
			        }
			       
			};
			docClient.query(params, function(err, data) {
				if(err)
					{
					console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
					}
				else
					{
								console.log(data.Count);
				   					var coustr;
				   					data.Items.forEach(function(movie) {
				   						console.log(movie);
				                     coustr=movie.Count+1;
				                     console.log("latest BookingId:"+coustr)
				   					console.log(coustr);
							   			var params1={
										TableName : "BookingDetail",
										Item:{
											UserName:{S:UserName},
											BookingId:{N:coustr.toString()},
											BookingDate:{S:Bookingdate},
											Flag:{S:Flag},
											FromTime:{S:FromTime},
											PaymentAmount:{S:PaymentAmount},
											PaymentMethod:{S:Paymentmethod},
											Status:{S:status},
											ToTime:{S:ToTime},
											SensorName:{S:SensorName},
											VehicleNumber:{S:VehicleNumber},
											Email:{S:sessionStorage.getItem("Email")}
										}
									};
							   console.log("ok till now")
							   dynamodb.putItem(params1,function(err, data){
									if (err)
										{
										console.log(err, err.stack); // an error occurred
										}
									   else    
										   {
										   console.log("Inserted");
										   document.getElementById("popup-1").classList.toggle("active");   
										   }
							
							   
							});
							   console.log(coustr+": coustr")
							   var params2={
										TableName : "UserTypeCount",
										Item:{
											UserType:{S:"Bookings"},
											Count:{N:coustr.toString()}
										}
								};
								dynamodb.putItem(params2,function(err, data){
									if (err) console.log(err, err.stack); // an error occurred
									   else     console.log(data);
								});
							   
							});
				   }
					
			});
	   
	   
	}  
}
function appendLeadingZeroes(n){
	  if(n <= 9){
	    return "0" + n;
	  }
	  return n
	}
function displaytooptions()
{
	console.log("in displaytooptions method");
	var selector=document.getElementById("From");
	console.log(selector.selectedIndex);
	var n=document.getElementById("From").value.substring(0,2);
	console.log(n);
	var options = document.querySelectorAll('#To option');
	  options.forEach(o => o.remove());
	for (i = Number(n)+1; i < Number(n)+13 && i<24; i++) {
		console.log("in for loop");
	var x = document.getElementById("To");
	  var option = document.createElement("option");
	  
	  option.value = appendLeadingZeroes(i)+":00";
	  option.text=appendLeadingZeroes(i)+":00";
	  x.add(option);
	}
	displayslots();
	}
	
	function displayfromoptions()
	{
		const current_datetime=new Date();
		console.log(current_datetime);
		const Todaydate= current_datetime.getFullYear()+ "-"+ appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate()) ;

		if(document.getElementById("date").value==Todaydate)
			{
		var d=new Date();
	 	var hours=d.getHours();
	 	var d=new Date();
	 	var currenthours=d.getHours();
	 	var options = document.querySelectorAll('#From option');
		  options.forEach(o => o.remove());
		for (i = currenthours+1; i<23; i++) {
			console.log("in for loop");
		var x = document.getElementById("From");
		  var option = document.createElement("option");
		  
		  option.value = appendLeadingZeroes(i)+":00";
		  option.text=appendLeadingZeroes(i)+":00";
		  x.add(option);
	 	}	
		displaytooptions();
			}
		else if(document.getElementById("date").value > Todaydate)
			{
			var options = document.querySelectorAll('#From option');
			  options.forEach(o => o.remove());
			for (i = 0; i<23; i++) {
				console.log("in for loop");
			var x = document.getElementById("From");
			  var option = document.createElement("option");
			  
			  option.value = appendLeadingZeroes(i)+":00";
			  option.text=appendLeadingZeroes(i)+":00";
			  x.add(option);
			}
			displaytooptions();
			}
		
			else
			{
			var options = document.querySelectorAll('#From option');
			  options.forEach(o => o.remove());
			  var options = document.querySelectorAll('#To option');
			  options.forEach(o => o.remove());
			}
	}
function displayslots() {
	var n1=document.getElementById("From").value.substring(0,2);
	var n2=document.getElementById("To").value.substring(0,2);
	console.log("value: "+document.getElementById("To").value);
	console.log("text: "+document.getElementById("To").innerHTML);
	console.log(n1);
	console.log(n2);
	var amount=(n2-n1) * 10;
	console.log(amount);
	document.getElementById("payamount").value=amount;
	if(document.getElementById('useCredit').checked)
	{
		CheckCredit();
	}
	else if(document.getElementById('usePaypal').checked)
		{
		CheckpayPal();
		}
	const todaydate= document.getElementById("date").value;
	console.log(todaydate);
	var params11={
			 TableName : "BookingDetail",
			 FilterExpression: ":one > #FromTime AND :one <#ToTime  AND #BookingDate = :date AND #UserName= :username OR :two > #FromTime AND :two <#ToTime  AND #BookingDate = :date AND #UserName= :username OR #BookingDate = :date AND #FromTime = :one AND #UserName= :username OR #BookingDate = :date AND #ToTime = :two AND #UserName= :username",
			 ExpressionAttributeNames:{
		            "#FromTime":"FromTime",
		            "#ToTime":"ToTime",
		            "#BookingDate":"BookingDate",
		            "#UserName":"UserName"
		        },
		        ExpressionAttributeValues: {
		        	":one":document.getElementById("From").value,
		        	":two":document.getElementById("To").value,
		        	":date":todaydate,
		        	":username":sessionStorage.getItem("UserName")
		        }
		        
		};
	docClient.scan(params11, onScan);
	function onScan(err, data) {
		if(err)
			{
			console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
			}else{
				var count=data.Count;
				var options = document.querySelectorAll('#Slot option');
				  options.forEach(o => o.remove());
				if(count>0)
					{
					console.log("already have booking");
					document.getElementById("Tomessage").innerHTML="you already have booking for this time.<br>\ please select different time window.";
					}
		
	
	
				else{
					document.getElementById("Tomessage").innerHTML="";
	
	  const current_datetime=new Date();
	var params={
			 TableName : "BookingDetail",
			 FilterExpression: ":one > #FromTime AND :one <#ToTime  AND #BookingDate = :date OR :two > #FromTime AND :two <#ToTime  AND #BookingDate = :date OR #BookingDate = :date AND #FromTime = :one OR #BookingDate = :date AND #ToTime = :two",
			 ExpressionAttributeNames:{
		            "#FromTime":"FromTime",
		            "#ToTime":"ToTime",
		            "#BookingDate":"BookingDate"
		        },
		        ExpressionAttributeValues: {
		        	":one":document.getElementById("From").value,
		        	":two":document.getElementById("To").value,
		        	":date":todaydate
		        }
		        
		};
	docClient.scan(params, onScan);
	function onScan(err, data) {
		if(err)
			{
			console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
			}else{
				var count=data.Count;
				console.log(count);
				var slots=["Slot 1","Slot 2","Slot 3","Slot 4","Slot 5"];
				data.Items.forEach(function(movie) {
	                  
	                  if(slots.includes(movie.SensorName))
	                  {
	                	  delete slots[slots.indexOf(movie.SensorName)];
	                  }
	                  else
	                  {
	                  	
	                  }
	              });
				slots.sort();
				var x = document.getElementById("Slot");
				slots.forEach(myFunction); 
				function myFunction(item, index) 
				{ 
					console.log(item);
					  var option = document.createElement("option");
					  
					  switch(item) {
					  case "Slot 1":text="University Library";
					    // code block
					    break;
					  case "Slot 2":text="CS Department";
					    
					    break;
					  case "Slot 3":text="Student Faculty Building";
					    break;
					  case "Slot 4":text="University Theater";
					    break;
					  case "Slot 5":text="Wellness center";
					    break;
					  default:
					   
					}
					  option.text = text;
					  option.value=item
					  option.id=item;
					  x.add(option);
					}
				
			}
	}
			}}
	
}}

function togglePopup(){
	
	  
	  window.location.href="Bookings.html";
		
	}
function checkBookings()
{
	
	const current_datetime=new Date();
	console.log(current_datetime);
	const Todaydate= current_datetime.getFullYear()+ "-"+ appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate()) ;

	document.getElementById("date").min= Todaydate;
	console.log(Todaydate);
	var currhours=appendLeadingZeroes(new Date().getHours())+":00";
	console.log(currhours);
	console.log(sessionStorage.getItem("UserName"));

	
	var params = {
	        TableName : "BookingDetail",
	        ScanIndexForward: true,
	        FilterExpression: "#user = :name AND #BookingDate > :date AND #Flag <> :flag OR #user = :name AND #BookingDate = :date AND #ToTime > :hours AND #Flag <> :flag",
	        ExpressionAttributeNames: {
	            "#user": "UserName",
	            "#BookingDate":"BookingDate",
	            "#ToTime":"ToTime",
	            "#Flag":"Flag"
	        },
	        ExpressionAttributeValues: { ":name": sessionStorage.getItem("UserName"),":date":Todaydate, ":hours":currhours, ":flag":'Y'}
	             
	    };
	    docClient.scan(params, onScan);
	}
function onScan(err, data) {
    if (err) {
        console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
    }
    else
    {        
    	console.log(data.Count);
     if(data.Count>=5)
    {
    	 data.Items.forEach(function(movie) {
     		console.log(movie.BookingId);
     	});
    	 if (window.confirm("Sorry! you exceeded maximum bookings")) { 
			   window.location.href="Bookings.html";
			 }	

    	 }
     else
 	{
 	document.getElementById("form").style.display='block';
 	}
    }
    
    }
    
    function CheckCredit()
    {
    	document.getElementById("paypal-button").style.display='none';
    	console.log("In check Credit method");
    	 var params3 = {
		          TableName : "UserDetails",
		          KeyConditionExpression: "#uname = :UserName",
		          ExpressionAttributeNames:{
		              "#uname": "UserName"
		          },
		          ExpressionAttributeValues: {
		          	":UserName":sessionStorage.getItem("UserName")
		          }
		      };
	   docClient.query(params3, function(err, data) {
	        if (err) {
	            console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
	        }
	        else
	        {
	        	console.log(data.Count);
	        	data.Items.forEach(function(item) {
	        		document.getElementById("Available-credit").style.display='block';
	        		console.log(item.AvailableCredit);
	        		var userid=item.UserId;
	        		document.getElementById('availablecredit').value= item.AvailableCredit;
	        		if(item.AvailableCredit==0)
	        			{
	        			document.getElementById('creditmessage').innerHTML= "Please pay using paypal. You have zero credits."
	        			}	
	        		else{
	        		var aftercredit=parseInt(item.AvailableCredit)-parseInt(document.getElementById('payamount').value);
	        		if(aftercredit>=0)
	        		{
	        			sessionStorage.setItem("todeduct",aftercredit);
	        			document.getElementById('reserve').disabled=false;
	        			if(item.AvailableCredit!=0)
	        			{
	        			document.getElementById('creditmessage').innerHTML= document.getElementById('payamount').value+"$ will be deducted from your credit amount";
	        			}
	        			
	        		}
	        		else if(aftercredit<0)
	        			{
	        			aftercredit=parseInt(aftercredit)*(-1);
	        			if(item.AvailableCredit!=0)
	        			{
	        				document.getElementById('creditmessage').innerHTML= item.AvailableCredit+"$ will be deducted from your credit amount please pay remaining through PayPal ";
	        			}
	        			sessionStorage.setItem("todeduct",0);
	        			
	    				document.getElementById("paypal-button").style.display='block';
	    				sessionStorage.setItem("payamount",aftercredit);
	    				console.log(sessionStorage.getItem("payamount"));
	    				     
	        			}
	        		}
	        	});
	        
	        }});
	   
	    
    }
    
    function CheckpayPal()
    {
    	console.log(sessionStorage.setItem("payamount",document.getElementById('payamount').value));
    	document.getElementById("Available-credit").style.display='none';
    	document.getElementById("paypal-button").style.display='block';
    }
</script>

</head>
<body onload="checkBookings()">
<header>
<div class="topnav">
  <a href="SlotAvailability.html"><i class="fa fa-fw fa-home"></i> Home</a>
  <a href="Bookings.html">My Bookings</a>
  <a href="CancelledBookings.html">Cancellations</a>
  <div class="dropdown">
    <button class="dropbtn" >More <i class="fa fa-caret-down"></i></button>
    <div class="dropdown-content">
      <a href="showPredictData.html">Peak Hours</a>
      <a href="About.html">About</a>
      <a href="Contact.html">Contact us</a>
    </div>
  </div> 
  <div class="topnav-right">
     <div class="dropdown">
    <button class="dropbtn" style="background-color: #B0E0E6;color: black;">My Account <i class="fa fa-user-circle"></i></button>
    <div class="dropdown-content">
      <a href="MyAccount.html">Profile</a>
      <a href="index.html"><i class="fa fa-sign-out"></i>Logout </a>
    </div>
  </div> 
  </div>
</div>
</header>
<div align="center" class="table-form-container" id="form" style=" padding-top:20px; display:none">
<form style="width: 600px; height: 900px; border-style: groove; border-radius:15px; background-color: white; padding-top:25px; padding-left:20px" onsubmit="return false;">
     <img src="images/parking icon.jpg"  width="85" height="85">
    <table class="reservation-form">
        <tr>
            <td>
               <label class="label-form" for="datelabel">Select Date:</label>
            </td>
            <td>
                <input type="date"  id="date" required="Required" style="font-size:15px" onchange="displayfromoptions(this.id)" class="input-form" data-validate = "Selected date should be in future." name="date" placeholder="Select suitable date" />
            </td>
        </tr>
        <tr>
            <td>
                <label class="label-form" for="From" >From:</label>
            </td>
            <td>
                <select name="From" class="input-form" onchange="displaytooptions(this.id)" id="From" required="Required">

  </select>
            </td>
        </tr>
        <tr>
            <td>
                <label class="label-form"  for="To" >To :</label>
            </td>
            <td>
                <select name="To" class="input-form" onchange="displayslots()" id="To" required="Required">
  </select>
  </br>
  </br>
  </br>
  </br>
  <p id="Tomessage" style="text-align: left;font-size: inherit;"></p>
            </td>
        </tr>
        <tr>
            <td>
                <label class="label-form" for="SelectSlot">Select Slot :</label>
            </td>
            <td>
                <select name="Slot" class="input-form" id="Slot" required="Required">
            </td>
        </tr>
        <tr>
            <td>
                    <label class="label-form" for="Vehicle Number">Vehicle Number :</label>
            </td>
            <td>
                    <input  class="input-form"type="text" id="Vnum" name="Vnum" required="Required"><br><br>
            </td>
        </tr>
        <tr>
            <td>
                <label class="label-form" for="payment Amount">Price in $ :</label>
            </td>
            <td>
                <input  class="input-form"type="text" id="payamount" name="payamount" readonly="readonly" ><br><br>
            </td>
        </tr>
        
        <tr>
            <td>
                <label class="label-form" for="paymentType">Payment Method:</label>
            </td>
            <td style="float:left">
                
                    <input type="radio" value="useCredit" id="useCredit" name="paymentType" onClick="CheckCredit()">
                    <label for="useCredit"  >Use Your Credit  </label> 
                    <input type="radio" value="usePaypal" id="usePaypal" name="paymentType" onClick="CheckpayPal()">
                    <label for="usePaypal">Pay using PayPal</label>
          </td>
          </tr>
          <tr>
          <td>
          </td>
          <td>
            <div id="Available-credit" style="display:none;float:centre ">
            <label for="availablecredit">Available Credit :</label>
            <input  type="text" id="availablecredit" style="width: 30%;" name="availablecredit" readonly="readonly" ><br><br>
            <p id="creditmessage"></p>
            </div>
        
            <div id="paypal-button" hidden>
  <script>
        paypal.Button.render({

            env: 'sandbox', // sandbox | production

            // PayPal Client IDs - replace with your own
            // Create a PayPal app: https://developer.paypal.com/developer/applications/create
            client: {
                sandbox: 'AeYyMA9Yts9iAuw7c8YBRBRUo16xyopcaBJOmuF3GfMWiqE1gPC09slSDURsFZCLSm33nSoHxu52k90E',
                production: 'AVxLLM-i36D-84l6SzPLxZIeaPc4e-zY1EFbs2V3hrPrg-8KEjVYBitFrOVllgn8ERUmdl4pg44aBPp3'
            },

            // Show the buyer a 'Pay Now' button in the checkout flow
            commit: true,

            // payment() is called when the button is clicked
            payment: function (data, actions) {
                // Make a call to the REST api to create the payment
                return actions.payment.create({
                    payment: {
                        transactions: [
                            {
                                amount: {total: sessionStorage.getItem("payamount"), currency: 'USD'}
                            }
                        ]
                    }
                });
            },

            // onAuthorize() is called when the buyer approves the payment
            onAuthorize: function (data, actions) {
                // Make a call to the REST api to execute the payment
                return actions.payment.execute().then(function () {
                	document.getElementById('reserve').disabled=false;
                	window.alert("payment Complete!!");
                });
            }
        }, '#paypal-button');

    </script>
   </div>
    
            </td>
        </tr>
        <tr>
            <td>
            </td>
            <td>
                <button type="submit" class="input-form-button" id="reserve"  onClick= "ReserveSpace()"  >Reserve</button>
            </td>
        </tr>
    </table>
</form>

<div class="popup" id="popup-1">
  <div class="overlay"></div>
  <div class="content">
    <div class="close-btn" onclick="togglePopup('popup-1')">&times;</div>
    <p align="centre"> <i class="fa fa-check-circle" style="font-size:40px;color:blue"></i></br></br> Your booking has been made.</br></br>Thank you! </p>
  </div>
  
</div>
</div>
</body>
</html>
