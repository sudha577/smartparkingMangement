<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
 <link href="styles/styles.css" rel="stylesheet" type="text/css">
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.652.0.min.js"></script>
  <script type="text/javascript">
AWS.config.update({
	  region: "us-east-2",
	  endpoint: 'http://dynamodb.us-east-2.amazonaws.com',
	  accessKeyId: "AKIASUU5L6BWABM3DQEC",
	  secretAccessKey: "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"
	});  

var dynamodb = new AWS.DynamoDB();
var docClient = new AWS.DynamoDB.DocumentClient();
var ddb = new AWS.DynamoDB({apiVersion: '2012-08-10'});
function onLoad()
{
	
	var params = {
	        TableName : "BookingDetails",
	        ScanIndexForward: false,
	        FilterExpression: "#BookingId = :BookingId",
	        ExpressionAttributeNames: {
	            "#BookingId": "BookingId",
	        },
	        ExpressionAttributeValues: { ":BookingId": sessionStorage.getItem("Extenditem")}
	             
	    };
	docClient.scan(params, onScan);
	function onScan(err, data) {
		if(err)
			{
			console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
			}else{
				var count=data.Count;
				console.log(count);
				var extendFrom;
				
				data.Items.forEach(function(item) {
					document.getElementById('From').value=item.FromTime;
					sessionStorage.setItem("ExtendTime",item.SensorName);
					extendFrom=item.ToTime;
					console.log("extend From :    "+extendFrom)
					sessionStorage.setItem("ToExtend",item.SensorName);
	                  
	              });
				var n=extendFrom.substring(0,2);
				var options = document.querySelectorAll('#To option');
				  options.forEach(o => o.remove());
				for (i = n; i < 24; i++) {
					console.log("in for loop");
				var x = document.getElementById("To");
				  var option = document.createElement("option");
				  
				  option.text = appendLeadingZeroes(i)+":00";
				  option.id=i;
				  x.add(option);
				}
				
			}
	}
	
	}
function displayslots() {
var slot=sessionStorage.getItem("ToExtend");
const current_datetime=new Date();
const todaydate= appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate())+"-"+current_datetime.getFullYear() ;
console.log(todaydate);
var params = {
        TableName : "BookingDetails",
        ScanIndexForward: false,
        FilterExpression: "#SensorName = :SensorName AND #BookingDate=:Date AND #FromTime=:",
        ExpressionAttributeNames: {
            "#SensorName": "SensorName",
            "#BookingDate": "BookingDate"
        },
        ExpressionAttributeValues: { ":SensorName": slot,":Date": todaydate}            
    };
docClient.scan(params, onScan);
function onScan(err, data) {
	if(err)
		{
		console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
		}else{
			var count=data.Count;
			console.log(count);
			if(count>0)
				{
				document.getElementById('slotselection').style.visibility='visible';
				displayslots1();
				}
			else
				{
				
				}
			
		}
}

}
function displayslots1() {
	
	var options = document.querySelectorAll('#Slot option');
	  options.forEach(o => o.remove());
	  const current_datetime=new Date();
		const todaydate= appendLeadingZeroes(current_datetime.getMonth() + 1) + "-" + appendLeadingZeroes(current_datetime.getDate())+"-"+current_datetime.getFullYear() ;
		console.log(todaydate);
		console.log(document.getElementById("From").value);
		console.log(document.getElementById("To").value);
	var params={
			 TableName : "BookingDetails",
			 FilterExpression: " #FromTime > :one AND #FromTime < :two AND #BookingDate = :date OR #ToTime > :one AND #ToTime < :two AND #BookingDate = :date",
			 ExpressionAttributeNames:{
		            "#FromTime":"FromTime",
		            "#ToTime":"ToTime",
		            "#BookingDate":"BookingDate"
		        },
		        ExpressionAttributeValues: {
		        	":one":document.getElementById("From").value,
		        	":two":document.getElementById("To").value,
		        	":date":todaydate
		        }
		        
		};
	docClient.scan(params, onScan);
	function onScan(err, data) {
		if(err)
			{
			console.error("Unable to scan the table. Error JSON:", JSON.stringify(err, null, 2));
			}else{
				var count=data.Count;
				console.log(count);
				var slots=["Slot 1","Slot 2","Slot 3","Slot 4","Slot 5"];
				data.Items.forEach(function(movie) {
	                  
	                  if(slots.includes(movie.SensorName))
	                  {
	                	  delete slots[slots.indexOf(movie.SensorName)];
	                  }
	                  else
	                  {
	                  	
	                  }
	              });
				slots.sort();
				var x = document.getElementById("Slot");
				slots.forEach(myFunction); 
				function myFunction(item, index) 
				{ 
					console.log(item);
					  var option = document.createElement("option");
					  option.text = item;
					  option.id=item;
					  x.add(option);
					}
				
			}
	}
	
}
	

function appendLeadingZeroes(n){
	  if(n <= 9){
	    return "0" + n;
	  }
	  return n;
}
</script>
<title>Insert title here</title>
</head>
<body onload="onLoad()">

<header>
	 <div class="topnav">
	 <div align="left"> 
		 <a	 id="home" href="availability.html" >HOME</a>	
          <a  id="about" href="About.html" >ABOUT</a>		
          <a  id="contact"href="Contact.html" >CONTACT US</a>
          </div>	
          <div style="left-padding:100px">
          <a  id="booking" href="Bookings.html">My Bookings</a>	
          <a  id="account"href="Myaccount.html" >My Account</a>		
		</div>
		</div>
</header>
<div align="center" style=" padding-top:20px">
<form style="width: 600px; height: 700px; border-style: groove; border-radius:15px; background-color: white; padding-top:25px; padding-left:120px" onsubmit="return false;">

  <label class="label-form" for="from">From :</label>
  <input  class="input-form"type="text" id="From" name="from" readonly="readonly" ><br><br>

    <label class="label-form"  for="To" >To :</label>
  <select name="To" class="input-form" onchange="displayslots()" id="To">
  </select>
    <div class="hidden" id="slotselection">
    
    <label class="label-form" for="SelectSlot">please select another Slot :</label>
    <select name="Slot" class="input-form" id="Slot">
    </select>
    </div>
      <label class="label-form" for="payment Amount">Payment Amount in $ :</label>
  <input  class="input-form"type="text" id="payamount" name="payamount" readonly="readonly" ><br><br>
 
  <div id="paypal-button"></div>
  <script>
        paypal.Button.render({

            env: 'sandbox', // sandbox | production

            // PayPal Client IDs - replace with your own
            // Create a PayPal app: https://developer.paypal.com/developer/applications/create
            client: {
                sandbox: 'AeYyMA9Yts9iAuw7c8YBRBRUo16xyopcaBJOmuF3GfMWiqE1gPC09slSDURsFZCLSm33nSoHxu52k90E',
                production: 'AVxLLM-i36D-84l6SzPLxZIeaPc4e-zY1EFbs2V3hrPrg-8KEjVYBitFrOVllgn8ERUmdl4pg44aBPp3'
            },

            // Show the buyer a 'Pay Now' button in the checkout flow
            commit: true,

            // payment() is called when the button is clicked
            payment: function (data, actions) {
                // Make a call to the REST api to create the payment
                return actions.payment.create({
                    payment: {
                        transactions: [
                            {
                                amount: {total: document.getElementById('payamount').value, currency: 'USD'}
                            }
                        ]
                    }
                });
            },

            // onAuthorize() is called when the buyer approves the payment
            onAuthorize: function (data, actions) {
                // Make a call to the REST api to execute the payment
                return actions.payment.execute().then(function () {
                	document.getElementById('reserve').disabled=false;
                  window.alert('Payment Complete!');
                });
            }
        }, '#paypal-button');

    </script>
  <button class="button" id="Extend"  onClick= "Extend()" disabled >Extend Booking</button>
</form>
</div>

</body>
</html>